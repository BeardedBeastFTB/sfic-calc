<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Key SFIC Pinning Calculator</title>
 <link href="./dist/output.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .table-cell {
            transition: all 0.3s ease;
        }
        .table-row-enter {
            opacity: 0;
            transform: translateY(10px);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Multi-Key SFIC Pinning Calculator</h1>
            <p class="text-slate-400 mt-2">An interactive tool for the A2 pinning system (23 stack total).</p>
        </header>

        <main class="bg-slate-800 rounded-xl shadow-2xl p-6 sm:p-8">
            <!-- Input Section -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4 text-white">Key Bitting Inputs</h2>
                <div id="all-keys-container" class="space-y-4">
                    <!-- JS will generate all key rows here -->
                </div>
                <div class="mt-4 flex flex-wrap gap-2">
                    <button id="add-operating-key" class="flex-grow sm:flex-grow-0 px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg transition-colors shadow-md flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Add Operating Key
                    </button>
                    <button id="clear-all" class="flex-grow sm:flex-grow-0 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors shadow-md flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Results Table -->
            <div>
                <h2 class="text-xl font-semibold mb-4 text-white">Pinning Chart</h2>
                <div class="overflow-x-auto rounded-lg border border-slate-700">
                    <table class="w-full text-center">
                        <thead class="bg-slate-700/50">
                            <tr>
                                <th class="p-3 text-sm font-semibold tracking-wide">Chamber</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">Bottom Pin</th>
                                <th class="p-3 text-sm font-semibold tracking-wide text-yellow-400">Master Pin(s)</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">Top Pin</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="divide-y divide-slate-700">
                           <!-- JS will generate result rows here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Formulas Section -->
            <div class="mt-8 pt-6 border-t border-slate-700">
                 <h3 class="text-lg font-semibold text-white mb-3">Multi-Key Calculation Logic</h3>
                 <div class="text-slate-300 space-y-2 text-sm">
                    <p><strong class="font-semibold text-cyan-400">1. All Cuts:</strong> All unique bitting numbers from the Control and all Operating keys (including Grand Master) are collected for each chamber.</p>
                    <p><strong class="font-semibold text-cyan-400">2. Bottom Pin:</strong> The <strong class="text-white">smallest</strong> unique cut number for that chamber becomes the bottom pin.</p>
                    <p><strong class="font-semibold text-cyan-400">3. Top Pin:</strong> Calculated as 23 minus the <strong class="text-white">largest</strong> unique cut number.</p>
                    <p><strong class="font-semibold text-cyan-400">4. Master Pins:</strong> These are the calculated differences between each consecutive cut, from smallest to largest, to create all required shear lines.</p>
                 </div>
            </div>

        </main>
        
        <footer class="text-center mt-8 text-slate-500 text-sm">
            <p>Designed for SFIC locksmithing professionals and enthusiasts.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allKeysContainer = document.getElementById('all-keys-container');
            const addOperatingKeyBtn = document.getElementById('add-operating-key');
            const clearAllBtn = document.getElementById('clear-all');
            const resultsTbody = document.getElementById('results-tbody');
            const TOTAL_STACK = 23;
            let operatingKeyCount = 0;
            let operatingKeysSubContainer;

            function createInput(id) {
                const input = document.createElement('input');
                input.type = 'number';
                input.id = id;
                input.min = 0;
                input.max = 9;
                input.className = "w-full h-12 rounded-lg bg-slate-700 text-center text-lg font-mono font-bold text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition";
                input.setAttribute('placeholder', '-');
                
                // --- EVENT LISTENERS FOR QoL FEATURES ---

                // Main listener for calculations and auto-advancing
                input.addEventListener('input', (e) => {
                    calculatePinning(); // Recalculate on any input
                    
                    const target = e.target;
                    // Auto-advance if a single digit is entered
                    if (target.value.length >= 1) {
                        target.value = target.value.slice(-1); // Ensure only one digit
                        
                        const allInputs = Array.from(document.querySelectorAll('#all-keys-container input[type="number"]'));
                        const currentIndex = allInputs.indexOf(target);

                        if (currentIndex < allInputs.length - 1) {
                            allInputs[currentIndex + 1].focus();
                        } else {
                            addOperatingKeyBtn.focus();
                        }
                    }
                });
                
                // Listener for backspace/delete to move backwards
                input.addEventListener('keydown', (e) => {
                    if ((e.key === 'Backspace' || e.key === 'Delete') && e.target.value === '') {
                        e.preventDefault();
                        const allInputs = Array.from(document.querySelectorAll('#all-keys-container input[type="number"]'));
                        const currentIndex = allInputs.indexOf(e.target);

                        if (currentIndex > 0) {
                            allInputs[currentIndex - 1].focus();
                        }
                    }
                });

                return input;
            }

            function createKeyRow(idPrefix, labelText, isRemovable) {
                const rowContainer = document.createElement('div');
                
                const label = document.createElement('h3');
                label.className = 'text-lg font-medium mb-2 text-slate-300';
                label.textContent = labelText;
                rowContainer.appendChild(label);

                const rowWrapper = document.createElement('div');
                rowWrapper.className = 'flex items-center gap-2';
                rowWrapper.id = idPrefix;
                rowContainer.appendChild(rowWrapper);
                
                const inputGrid = document.createElement('div');
                inputGrid.className = 'grid grid-cols-7 gap-2 flex-grow';
                rowWrapper.appendChild(inputGrid);

                for (let i = 1; i <= 7; i++) {
                    const input = createInput(`${idPrefix}-cut-${i}`);
                    inputGrid.appendChild(input);
                }

                if (isRemovable) {
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                    removeBtn.className = 'flex-shrink-0 p-1 bg-slate-700/50 hover:bg-red-500/80 text-slate-400 hover:text-white rounded-lg transition-colors';
                    removeBtn.setAttribute('title', 'Remove Key');
                    removeBtn.onclick = () => {
                        rowContainer.remove();
                        // Re-label remaining dynamic keys
                        const remainingOpKeys = operatingKeysSubContainer.children;
                        for(let i = 0; i < remainingOpKeys.length; i++){
                            remainingOpKeys[i].querySelector('h3').textContent = `Operating Key #${i + 1}`;
                        }
                        calculatePinning();
                    };
                    rowWrapper.appendChild(removeBtn);
                }
                return rowContainer;
            }

            function addOperatingKeyRow() {
                operatingKeyCount = operatingKeysSubContainer.children.length;
                const newOpRow = createKeyRow(`op-${operatingKeyCount + 1}`, `Operating Key #${operatingKeyCount + 1}`, true);
                operatingKeysSubContainer.appendChild(newOpRow);

                // --- New Feature: Focus first input of the new row ---
                const firstInputOfNewRow = newOpRow.querySelector('input[type="number"]');
                if (firstInputOfNewRow) {
                    firstInputOfNewRow.focus();
                }

                calculatePinning();
            }
            
            function initialize() {
                allKeysContainer.innerHTML = '';
                operatingKeyCount = 0;

                // Add static keys
                allKeysContainer.appendChild(createKeyRow('ctrl-main', 'Control Key', false));
                allKeysContainer.appendChild(createKeyRow('gmk-main', 'Grand Master Key', false));
                
                // Create and add the container for dynamic keys
                operatingKeysSubContainer = document.createElement('div');
                operatingKeysSubContainer.className = 'space-y-4 pt-4 border-t border-slate-700/50';
                allKeysContainer.appendChild(operatingKeysSubContainer);

                addOperatingKeyBtn.addEventListener('click', addOperatingKeyRow);

                clearAllBtn.addEventListener('click', () => {
                    const allInputs = document.querySelectorAll('#all-keys-container input[type="number"]');
                    allInputs.forEach(input => input.value = '');
                    calculatePinning();
                    // Focus the first input after clearing
                    if(allInputs.length > 0) {
                        allInputs[0].focus();
                    }
                });

                calculatePinning();
            }

            function calculatePinning() {
                resultsTbody.innerHTML = '';

                for (let chamber = 1; chamber <= 7; chamber++) {
                    const allCuts = [];
                    
                    // Collect cuts from GMK, Control, and all dynamic Operating keys
                    const keyPrefixes = ['gmk-main', 'ctrl-main'];
                    const opKeyRows = operatingKeysSubContainer ? operatingKeysSubContainer.querySelectorAll('.flex') : [];
                    opKeyRows.forEach(row => keyPrefixes.push(row.id));

                    keyPrefixes.forEach(prefix => {
                        if(!prefix) return;
                        const cutEl = document.querySelector(`#${prefix}-cut-${chamber}`);
                        if (cutEl && cutEl.value !== '') {
                            allCuts.push(parseInt(cutEl.value, 10));
                        }
                    });

                    let bottomPin = '-';
                    let masterPins = '-';
                    let topPin = '-';
                    let masterPinColor = 'text-yellow-400';

                    if (allCuts.length > 0) {
                        const uniqueSortedCuts = [...new Set(allCuts)].sort((a, b) => a - b);
                        
                        bottomPin = uniqueSortedCuts[0];
                        topPin = TOTAL_STACK - uniqueSortedCuts[uniqueSortedCuts.length - 1];

                        if (uniqueSortedCuts.length > 1) {
                            const masters = [];
                            for (let j = 1; j < uniqueSortedCuts.length; j++) {
                                masters.push(uniqueSortedCuts[j] - uniqueSortedCuts[j - 1]);
                            }
                            masterPins = masters.join(', ');
                        } else {
                            masterPins = '0';
                            masterPinColor = 'text-slate-400';
                        }
                    }

                    const row = document.createElement('tr');
                    row.className = 'table-row-enter';
                    row.innerHTML = `
                        <td class="p-3 font-bold text-slate-400 table-cell">${chamber}</td>
                        <td class="p-3 font-mono text-lg table-cell">${bottomPin}</td>
                        <td class="p-3 font-mono text-lg font-bold ${masterPinColor} table-cell">${masterPins}</td>
                        <td class="p-3 font-mono text-lg table-cell">${topPin}</td>
                    `;
                    resultsTbody.appendChild(row);
                    
                    requestAnimationFrame(() => {
                        row.style.opacity = '1';
                        row.style.transform = 'translateY(0)';
                    });
                }
            }
            
            initialize();
        });
    </script>
</body>
</html>



